---
- name: Configure pacman
  lineinfile:
    path: /etc/pacman.conf
    line: '{{ item.line }}'
    regexp: '{{ item.regexp }}'
  with_items: '{{ pacman_options }}'
  become: yes

- name: Configure makepkg
  lineinfile:
    path: /etc/makepkg.conf
    line: '{{ item.line }}'
    regexp: '{{ item.regexp }}'
  with_items: '{{ makepkg_options }}'
  become: yes

- name: Add archlinuxcn repository to pacman
  ini_file:
    path: /etc/pacman.conf
    section: archlinuxcn
    option: Server
    value: https://repo.archlinuxcn.org/{{ ansible_architecture }}
  become: yes

- name: Install archlinuxcn keyring
  pacman:
    name: archlinuxcn-keyring
    state: latest
    update_cache: yes
  become: yes

- name: Install ccache
  command: 'pacman -S --noconfirm --needed ccache'
  register: paru_output
  changed_when: '"there is nothing to do" not in paru_output.stdout'
  become: yes

- name: Create folders for paru
  file:
    path: '{{ home_dir }}/.cache/paru/clone/{{ paru }}'
    state: directory

- name: Clone paru recipe
  git:
    repo: 'https://aur.archlinux.org/{{ paru }}'
    dest: '{{ home_dir }}/.cache/paru/clone/{{ paru }}'
    clone: yes
    force: yes

- name: Install paru package
  command: 'makepkg -si --noconfirm --needed'
  args:
    chdir: '{{ home_dir }}/.cache/paru/clone/{{ paru }}'
  register: makepkg_output
  changed_when: '"there is nothing to do" not in makepkg_output.stdout'
